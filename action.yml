name: 'Trigger GitLab CI through webhooks'
description: 'Triggers the GitLab CI pipeline through webhook pipeline trigger and associated token'
branding:
  icon: 'play'
  color: 'blue'
inputs:
  url:
    description: 'GitLab server url (at the level under which the API start)'
    required: true
    default: 'https://gitlab.com'
  project_id:
    description: 'GitLab project ID'
    required: true
    default: ''
  token:
    description: 'GitLab pipeline trigger token'
    required: true
    default: ''
  ref_name:
    description: 'GitLab project ref_name (branch or tag name; defaults to main)'
    required: false
    default: 'main'
  variables:
    description: 'Additional variables in VAR=value format to pass to the pipeline'
    required: false
    default: ''
  outputs:
    pipeline_url:
      description: 'The url to the downstream job'
      value: ${{ steps.trigger.outputs.pipeline_url }}

runs:
  using: "composite"
  steps:
    - id: trigger
      run: |
        echo "PARSING ${VARIABLES}"
        # Parse VARIABLES into multiple arguments
        for variable in ${VARIABLES} ; do
          if [[ $variable =~ ^([a-zA-Z_][a-zA-Z0-9_]*)=(.*) ]] ; then
            variable_args="${variable_args:-} -F variables[${BASH_REMATCH[1]}]=${BASH_REMATCH[2]}"
          else
            echo "Unable to parse variable $variable"
          fi
        done
        # Print webhook call
        echo curl -X POST \
             --fail \
             -o response.json \
             -F "token=${TOKEN}" \
             -F "ref=${REF_NAME}" \
             ${variable_args} \
             ${URL}/api/v4/projects/${PROJECT_ID}/trigger/pipeline
        # Call webhook
        curl -X POST \
             --fail \
             -o response.json \
             -F "token=${TOKEN}" \
             -F "ref=${REF_NAME}" \
             ${variable_args} \
             ${URL}/api/v4/projects/${PROJECT_ID}/trigger/pipeline
        pipeline=$(cat response.json | jq -c '.web_url')
        echo "PIPELINE=${pipeline}"
        echo "web_url: $(cat response.json | jq -c '.web_url')"
        echo "::set-output name=pipeline_url::${pipeline}"
      shell: bash
      env:
        URL: ${{ inputs.url }}
        PROJECT_ID: ${{ inputs.project_id }}
        TOKEN: ${{ inputs.token }}
        REF_NAME: ${{ inputs.ref_name }}
        VARIABLES: ${{ inputs.variables }}
